name: ğŸ§ª Tests Unitarios - Api MediSupply Capa de Dominio  Value Objects + Entities)

on:
  push:
    branches: [ '**' ]  # Todas las ramas
  pull_request:
    branches: [ '**' ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  domain-tests:
    name: Tests Unitarios - Dominio (Value Objects + Entities)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: 'apiMS/microservices/requirements.txt'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        cd apiMS/microservices
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: ğŸ§ª Ejecutar tests - Auth Service (Domain)
      run: |
        cd apiMS/microservices
        export PYTHONPATH=$(pwd)
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ” Auth Service - Domain Layer Tests"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        pytest auth-service/tests/unit/test_value_objects.py auth-service/tests/unit/test_entities.py -v --tb=short
    
    - name: ğŸ§ª Ejecutar tests - Product Service (Domain)
      run: |
        cd apiMS/microservices
        export PYTHONPATH=$(pwd)
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“¦ Product Service - Domain Layer Tests"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        pytest product-service/tests/unit/test_value_objects.py product-service/tests/unit/test_entities.py -v --tb=short
    
    - name: ğŸ§ª Ejecutar tests - Notifications Service (Domain)
      run: |
        cd apiMS/microservices
        export PYTHONPATH=$(pwd)
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”” Notifications Service - Domain Layer Tests"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        pytest notifications-service/tests/unit/test_entities.py -v --tb=short
    
    - name: ğŸ§ª Ejecutar tests - Shared (Domain)
      run: |
        cd apiMS/microservices
        export PYTHONPATH=$(pwd)
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”— Shared - Domain Layer Tests"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        pytest shared/tests/unit/ -v --tb=short
    
    - name: ğŸ“Š Generar reporte de cobertura - Domain Layer
      run: |
        cd apiMS/microservices
        export PYTHONPATH=$(pwd)
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š Generando cobertura de la capa de dominio"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Auth Service - Domain (Value Objects + Entities)
        echo "ğŸ” Generando cobertura Auth Service (Domain)..."
        pytest auth-service/tests/unit/test_value_objects.py auth-service/tests/unit/test_entities.py \
          --cov=auth-service/domain/value_objects \
          --cov=auth-service/domain/entities \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --quiet
        
        # Product Service - Domain (Value Objects + Entities)
        echo "ğŸ“¦ Generando cobertura Product Service (Domain)..."
        pytest product-service/tests/unit/test_value_objects.py product-service/tests/unit/test_entities.py \
          --cov=product-service/domain/value_objects \
          --cov=product-service/domain/entities \
          --cov-append \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --quiet
        
        # Notifications Service - Domain (Entities)
        echo "ğŸ”” Generando cobertura Notifications Service (Domain)..."
        pytest notifications-service/tests/unit/test_entities.py \
          --cov=notifications-service/domain/entities \
          --cov-append \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --quiet
        
        # Shared - Domain (Value Objects + Entity Base)
        echo "ğŸ”— Generando cobertura Shared (Domain)..."
        pytest shared/tests/unit/ \
          --cov=shared/domain/value_objects \
          --cov=shared/domain/entity \
          --cov-append \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --quiet
        
        # Mostrar resumen de cobertura solo para dominio
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š RESUMEN COBERTURA - CAPA DE DOMINIO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        coverage report \
          --include="*/domain/value_objects/*" \
          --include="*/domain/entities/*" \
          --include="shared/domain/value_objects.py" \
          --include="shared/domain/entity.py" \
          --show-missing || echo "âš ï¸  No se pudo generar el resumen"
    
    - name: ğŸ“¤ Subir reporte de cobertura
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.12'
      with:
        file: ./apiMS/microservices/coverage.xml
        fail_ci_if_error: false
        flags: domain-layer
      continue-on-error: true
    
    - name: ğŸ’¾ Guardar reporte HTML
      uses: actions/upload-artifact@v4
      if: matrix.python-version == '3.12'
      with:
        name: domain-coverage-report
        path: apiMS/microservices/htmlcov/
        retention-days: 30
    
    - name: âœ… Resumen de tests - Domain Layer
      if: always()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                                                              â•‘"
        echo "â•‘      âœ… TESTS DOMINIO (Value Objects + Entities)           â•‘"
        echo "â•‘                                                              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“Š Resultados:"
        echo "âœ… Auth Service: 33 tests (Value Objects + Entities)"
        echo "âœ… Product Service: 34 tests (Value Objects + Entities)"
        echo "âœ… Notifications Service: 3 tests (Entities)"
        echo "âœ… Shared: 5 tests (Value Objects + Entity Base)"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š TOTAL: 75 tests unitarios de dominio"
        echo "ğŸ¯ Enfoque: Solo capa de dominio (Value Objects + Entities)"
        echo "VersiÃ³n Python: ${{ matrix.python-version }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ‰ Pipeline completado!"

