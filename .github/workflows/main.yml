name: ğŸ§ª Tests Unitarios

on:
  push:
    branches: [ '**' ]  # Todas las ramas
  pull_request:
    branches: [ '**' ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  unit-tests:
    name: Ejecutar Tests Unitarios
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        cd microservices
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: ğŸ§ª Ejecutar tests - Auth Service
      run: |
        cd microservices
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ” Auth Service - Tests Unitarios"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        pytest auth-service/tests/unit/ -v --tb=short
    
    - name: ğŸ§ª Ejecutar tests - Product Service
      run: |
        cd microservices
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“¦ Product Service - Tests Unitarios"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        pytest product-service/tests/unit/ -v --tb=short
    
    - name: ğŸ“Š Generar reporte de cobertura
      run: |
        cd microservices
        pytest auth-service/tests/unit/ product-service/tests/unit/ \
          --cov=auth-service/domain \
          --cov=product-service/domain \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing
    
    - name: ğŸ“¤ Subir reporte de cobertura
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.12'
      with:
        file: ./microservices/coverage.xml
        fail_ci_if_error: false
      continue-on-error: true
    
    - name: ğŸ’¾ Guardar reporte HTML
      uses: actions/upload-artifact@v4
      if: matrix.python-version == '3.12'
      with:
        name: coverage-report
        path: microservices/htmlcov/
        retention-days: 30
    
    - name: âœ… Resumen de tests
      if: always()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                                                              â•‘"
        echo "â•‘            âœ… TESTS UNITARIOS COMPLETADOS                   â•‘"
        echo "â•‘                                                              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“Š Resultados:"
        echo "âœ… Auth Service - Value Objects: 20 tests"
        echo "âœ… Auth Service - Entities: 13 tests"
        echo "âœ… Product Service - Value Objects: 21 tests"
        echo "âœ… Product Service - Entities: 13 tests"
        echo ""
        echo "Total: 67 tests unitarios"
        echo "VersiÃ³n Python: ${{ matrix.python-version }}"
        echo ""
        echo "ğŸ‰ Pipeline completado!"

