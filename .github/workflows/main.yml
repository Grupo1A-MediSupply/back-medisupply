name: ğŸš€ Deploy to AWS ECS v5

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**']
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  ECS_SERVICE: medisupply-service
  ECS_CLUSTER: medisupply-cluster
  ECS_TASK_DEFINITION: medisupply-task-definition
  CONTAINER_NAME: medisupply-container

jobs:
  # Job para tests y build
  test-and-build:
    name: ğŸ§ª Test & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'apiMS/microservices/requirements.txt'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        cd apiMS/microservices
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: ğŸ§ª Ejecutar tests
      run: |
        cd apiMS/microservices
        export PYTHONPATH=$(pwd)
        pytest auth-service/tests/unit/test_value_objects.py auth-service/tests/unit/test_entities.py product-service/tests/unit/ -v --tb=short
    
    - name: ğŸ“Š Generar reporte de cobertura
      run: |
        cd apiMS/microservices
        export PYTHONPATH=$(pwd)
        pytest auth-service/tests/unit/test_value_objects.py auth-service/tests/unit/test_entities.py product-service/tests/unit/ \
          --cov=auth-service/domain --cov=product-service/domain \
          --cov-report=xml --cov-report=html --cov-report=term-missing

  # Job para build y push de imÃ¡genes Docker
  build-and-push:
    name: ğŸ³ Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    strategy:
      matrix:
        service: [auth-service, product-service]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ” Configurar AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ”‘ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: ğŸ—ï¸ Build, tag, and push image to Amazon ECR
      env:
        ECR_REPOSITORY: medisupply-${{ matrix.service }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build image
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                     -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                     -f apiMS/microservices/${{ matrix.service }}/Dockerfile \
                     apiMS/microservices/
        
        # Push image
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Save image URI for deployment
        echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  # Job para despliegue con Terraform
  deploy-infrastructure:
    name: ğŸ—ï¸ Deploy Infrastructure with Terraform
    runs-on: ubuntu-latest
    needs: [test-and-build, build-and-push]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ” Configurar AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ“‹ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: ğŸ” Terraform Format Check
      run: terraform fmt -check -recursive terraform/
      working-directory: terraform/
    
    - name: ğŸ” Terraform Init
      run: terraform init
      working-directory: terraform/
    
    - name: ğŸ” Terraform Validate
      run: terraform validate
      working-directory: terraform/
    
    - name: ğŸ“Š Terraform Plan
      run: terraform plan -out=tfplan
      working-directory: terraform/
    
    - name: ğŸš€ Terraform Apply
      run: terraform apply -auto-approve tfplan
      working-directory: terraform/
    
    - name: ğŸ“ Output ECS Service URL
      run: |
        echo "ECS Service deployed successfully!"
        terraform output -json | jq -r '.ecs_service_url.value' >> $GITHUB_OUTPUT
      working-directory: terraform/

  # Job para actualizar servicio ECS
  update-ecs-service:
    name: ğŸ”„ Update ECS Service
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ” Configurar AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ”„ Update ECS service
      run: |
        # Force new deployment
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --force-new-deployment
        
        # Wait for deployment to complete
        aws ecs wait services-stable \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE
        
        echo "âœ… ECS service updated successfully!"
    
    - name: ğŸ“Š Verificar salud del servicio
      run: |
        echo "ğŸ” Checking service health..."
        aws ecs describe-services \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE \
          --query 'services[0].deployments[0].{status:status,runningCount:runningCount,desiredCount:desiredCount}'
