name: 游깿 Nightly Tests - Tests Nocturnos

on:
  schedule:
    # Ejecutar todos los d칤as a las 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Permite ejecuci칩n manual

jobs:
  comprehensive-tests:
    name: 游빍 Tests Completos Nocturnos
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: 游닌 Checkout c칩digo
      uses: actions/checkout@v4
    
    - name: 游냀 Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: 游닍 Instalar todas las dependencias
      run: |
        cd microservices
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        pip install flake8 black isort mypy pylint
    
    - name: 游빍 Ejecutar tests con m치xima verbosidad
      run: |
        cd microservices
        pytest auth-service/tests/unit/ -vv --tb=long
        pytest product-service/tests/unit/ -vv --tb=long
    
    - name: 游늵 Generar reporte completo de cobertura
      run: |
        cd microservices
        pytest auth-service/tests/unit/ product-service/tests/unit/ \
          --cov=auth-service \
          --cov=product-service \
          --cov-report=html \
          --cov-report=xml \
          --cov-report=term-missing
    
    - name: 游닋 Subir reporte
      uses: actions/upload-artifact@v4
      with:
        name: nightly-coverage-py${{ matrix.python-version }}
        path: microservices/htmlcov/
    
    - name: 游댌 An치lisis de calidad completo
      run: |
        cd microservices
        echo "游꿛 Verificando formato..."
        black --check auth-service/ product-service/ shared/ || true
        
        echo "游늺 Verificando imports..."
        isort --check-only auth-service/ product-service/ shared/ || true
        
        echo "游댌 An치lisis est치tico..."
        flake8 auth-service/ product-service/ shared/ --max-line-length=100 || true
    
    - name: 游닎 Notificar resultados
      if: failure()
      run: |
        echo "丘멆잺 Tests nocturnos fallaron en Python ${{ matrix.python-version }}"
        echo "Se recomienda revisar los logs"

